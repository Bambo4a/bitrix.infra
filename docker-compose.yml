version: '2'

services:
    certbot:
        image: certbot/certbot
        hostname: certbot
        container_name: certbot
        restart: unless-stopped
        volumes:
            - ./config/letsencrypt:/etc/letsencrypt
        entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 10d & wait $${!}; done;'"

    percona-server:
        image: percona:8
        hostname: percona-server
        container_name: percona-server
        restart: always
        # MYSQL_ROOT_PASSWORD, MYSQL_USER, MYSQL_PASSWORD
        env_file: docker/environment/percona.env
        expose:
            - "3306"
        # TODO: remove after migration of app into docker
        ports:
            - "13306:3306"
        volumes:
            # Data persistence
            - ./docker/percona-data:/var/lib/mysql
        environment:
            MYSQL_ROOT_HOST: localhost
            MYSQL_DATABASE: admin_favorgroup

    adminer:
        image: adminer:fastcgi
        hostname: adminer
        container_name: adminer
        restart: always
        expose:
            - "9000"

# Percona monitoring tools
    pmm-server:
        image: percona/pmm-server
        hostname: pmm-server
        container_name: pmm-server
        restart: always
        expose:
            - "443"
        # SERVER_PASSWORD
        env_file: docker/environment/percona.env
        environment:
            - SERVER_USER=pmm_docker_user

    pmm-client-ps:
        image: perconalab/pmm-client
        hostname: pmm-client-ps
        container_name: pmm-client-ps
        restart: always
        # PMM_PASSWORD, DB_PASSWORD
        env_file: docker/environment/percona.env
        environment:
            - PMM_SERVER=pmm-server:443
            - PMM_USER=pmm_docker_user
            - DB_TYPE=mysql
            - DB_HOST=percona-server
            - DB_PORT=3306
            - DB_USER=root

#    https://github.com/extremeshok/docker-nginx-pagespeed
#    nginx:
#        image: nginx:1.15-alpine
#        restart: unless-stopped
#        volumes:
#            - ./data/nginx:/etc/nginx/conf.d
#            - ./data/certbot/conf:/etc/letsencrypt
#            - ./data/certbot/www:/var/www/certbot
#        ports:
#            - "80:80"
#            - "443:443"
#        command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
